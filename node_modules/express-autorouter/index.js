'use strict';

var fs = require('fs'),
    path = require('path');

module.exports = function(pathToControllers, ext, indexController, indexMethod) {

    pathToControllers = path.normalize(path.join(path.dirname(require.main.filename), pathToControllers));

    indexController = indexController || 'index';
    indexMethod = indexMethod || 'index';

    ext = ext || '.js';
    if(ext.indexOf('.') < 0) ext = '.'+ext;

    return function(req, res, next) {
        var reqPath = req.path.replace(/(\/)\/+/g, '/').split('/');
        reqPath.splice(0, 1);
        if(reqPath[reqPath.length-1] === '') reqPath.splice(reqPath.length-1, 1);

        var checkController = function(name, method, cb) {
            fs.exists(pathToControllers+path.sep+name+ext, function(exists) {
                if(!exists) return cb();

                var controller = require(pathToControllers+path.sep+name);
                if(controller[method]) return controller[method](req, res, next);
                return cb();
            });
        };

        switch(reqPath.length) {
            case 0:
                checkController(indexController, indexMethod, next);
                break;
            case 1:
                checkController(reqPath[0], indexMethod, function() {
                    checkController(indexController, reqPath[0], function() {
                        checkController(reqPath[0]+path.sep+indexController, indexMethod, next);
                    })
                });
                break;
            default:
                var controller = reqPath.splice(reqPath.length-1, 1);
                checkController(reqPath.join(path.sep)+path.sep+controller, indexMethod, function() {
                    var method = controller;
                    controller = reqPath.splice(reqPath.length-1, 1);
                    checkController(reqPath.join(path.sep)+path.sep+controller, method, function() {
                        checkController(reqPath.join(path.sep)+path.sep+controller+path.sep+indexController, method, function() {
                            checkController(reqPath.join(path.sep)+path.sep+controller+path.sep+method+path.sep+indexController, indexMethod, next);
                        });
                    });
                });
                break;
        }
    }
};
